@model WebMobileStore.ViewModels.CheckoutViewModel
@{
    ViewBag.Title = "Thanh toán";
    Layout = "_ShopLayout";
}

<form asp-action="PlaceOrder" method="post" class="checkout">
    <div class="checkout__container">
        <!-- Bên trái: Thông tin vận chuyển -->
        <div class="checkout__left">
            <!-- Thông tin vận chuyển -->
            <div class="checkout__form">
                <h3 class="checkout__title">Thông tin vận chuyển</h3>

                <div class="checkout__input-row">
                    <input asp-for="User.FullName" placeholder="Họ tên" class="checkout__input" required />
                    <input asp-for="User.Phone" placeholder="Số điện thoại" class="checkout__input" required />
                </div>

                <input asp-for="User.Email" placeholder="Email" class="checkout__input" type="email" required />
                <input asp-for="User.Address" placeholder="Địa chỉ (số nhà, tên đường)" class="checkout__input" required />

                <div class="checkout__input-row">
                    <input asp-for="Ward" placeholder="Phường/Xã" class="checkout__input" required />
                    <input asp-for="District" placeholder="Quận/Huyện" class="checkout__input" required />
                </div>

                <input asp-for="City" placeholder="Tỉnh/Thành phố" class="checkout__input" required />
                @* <textarea asp-for="User.Address" placeholder="Ghi chú đơn hàng (tùy chọn)" class="checkout__textarea" rows="3"></textarea> *@
            </div>

            <!-- Hình thức thanh toán -->
            <div class="checkout__payment">
                <h3 class="checkout__title">Hình thức thanh toán</h3>

                <div class="payment-methods">
                    <!-- Thanh toán khi nhận hàng -->
                    <label class="payment-method">
                        <input type="radio" name="PaymentMethod" value="COD" checked />
                        <div class="payment-method__content">
                            <div class="payment-method__icon">
                                <svg width="32" height="32" viewBox="0 0 24 24" fill="none">
                                    <path d="M20 7H4C2.89543 7 2 7.89543 2 9V17C2 18.1046 2.89543 19 4 19H20C21.1046 19 22 18.1046 22 17V9C22 7.89543 21.1046 7 20 7Z" stroke="currentColor" stroke-width="2" />
                                    <path d="M8 15C9.10457 15 10 14.1046 10 13C10 11.8954 9.10457 11 8 11C6.89543 11 6 11.8954 6 13C6 14.1046 6.89543 15 8 15Z" stroke="currentColor" stroke-width="2" />
                                    <path d="M18 7V5C18 3.89543 17.1046 3 16 3H8C6.89543 3 6 3.89543 6 5V7" stroke="currentColor" stroke-width="2" />
                                </svg>
                            </div>
                            <div class="payment-method__info">
                                <strong>Thanh toán khi nhận hàng</strong>
                                <small>Thanh toán bằng tiền mặt khi nhận hàng</small>
                            </div>
                        </div>
                    </label>

                    <!-- Thanh toán qua Zalopay -->
                    <label class="payment-method">
                        <input type="radio" name="PaymentMethod" value="ZaloPay" />
                        <div class="payment-method__content">
                            <div class="payment-method__icon payment-method__icon--zalopay">
                                <svg width="32" height="32" viewBox="0 0 24 24" fill="none">
                                    <circle cx="12" cy="12" r="10" fill="#0068FF" />
                                    <path d="M8 12L11 15L16 9" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                </svg>
                            </div>
                            <div class="payment-method__info">
                                <strong>Thanh toán qua ZaloPay</strong>
                                <small>Hỗ trợ hình thức thanh toán: Visa, MasterCard, JCB, Napas</small>
                            </div>
                        </div>
                    </label>

                    <!-- Chuyển khoản ngân hàng -->
                    <label class="payment-method">
                        <input type="radio" name="PaymentMethod" value="BankTransfer" />
                        <div class="payment-method__content">
                            <div class="payment-method__icon payment-method__icon--bank">
                                <svg width="32" height="32" viewBox="0 0 24 24" fill="none">
                                    <path d="M3 9L12 2L21 9V20C21 20.5523 20.5523 21 20 21H4C3.44772 21 3 20.5523 3 20V9Z" stroke="currentColor" stroke-width="2" />
                                    <path d="M9 21V12H15V21" stroke="currentColor" stroke-width="2" />
                                </svg>
                            </div>
                            <div class="payment-method__info">
                                <strong>Chuyển khoản ngân hàng</strong>
                                <small>Chuyển khoản qua tài khoản ngân hàng</small>
                            </div>
                        </div>
                    </label>

                    <!-- Ví điện tử Momo -->
                    <label class="payment-method">
                        <input type="radio" name="PaymentMethod" value="Momo" />
                        <div class="payment-method__content">
                            <div class="payment-method__icon payment-method__icon--momo">
                                <svg width="32" height="32" viewBox="0 0 24 24" fill="none">
                                    <circle cx="12" cy="12" r="10" fill="#D82D8B" />
                                    <text x="12" y="16" text-anchor="middle" fill="white" font-weight="bold" font-size="12">M</text>
                                </svg>
                            </div>
                            <div class="payment-method__info">
                                <strong>Ví điện tử Momo</strong>
                                <small>Thanh toán qua ví điện tử Momo</small>
                            </div>
                        </div>
                    </label>
                </div>
            </div>
        </div>

        <!-- Bên phải: Giỏ hàng & thanh toán -->
        <div class="checkout__cart">
            <h3 class="checkout__title">Giỏ hàng</h3>

            <!-- Danh sách sản phẩm -->
            <div class="cart-items">
                @foreach (var item in Model.CartItems)
                {
                    <div class="cart-item">
                        <div class="cart-item__image">
                            @{
                                var firstImage = item.ProductVariant.Products.ProductImages.FirstOrDefault()?.ImageUrl ?? "/images/default.png";
                            }
                            <img src="@firstImage" alt="@item.ProductVariant.Products.ProductsName" />

                            <div class="cart-item__quantity-wrapper">
                                <button type="button" class="qty-btn qty-decrease">-</button>
                                <input type="text" name="CartItems[@item.CartItemId].Quantity" value="@item.Quantity" class="cart-item__quantity-input" readonly />
                                <button type="button" class="qty-btn qty-increase">+</button>
                            </div>
                        </div>


                        <div class="cart-item__info">
                            <span class="cart-item__name">@item.ProductVariant.Products.ProductsName</span>
                            <span class="cart-item__variant">@item.ProductVariant.Color / @item.ProductVariant.Storage</span>
                        </div>
                        <span class="cart-item__price" data-unit-price="@item.ProductVariant.Price">
                            @((item.Quantity * item.ProductVariant.Price).ToString("N0"))đ
                        </span>
                    </div>
                }
            </div>

            <!-- Mã giảm giá -->
            <div class="discount-section">
                <input type="text" placeholder="Nhập mã giảm giá" class="discount-section__input" />
                <button type="button" class="discount-section__button">Áp dụng</button>
            </div>

            <!-- Chi tiết thanh toán -->
            <div class="cart-summary">
                <div class="cart-summary__row">
                    <span>Tạm tính:</span>
                    <span id="subtotal">@Model.CartItems.Sum(i => i.Quantity * i.ProductVariant.Price).ToString("N0")</span>đ
                </div>
                <div class="cart-summary__row">
                    <span>Phí vận chuyển:</span>
                    <span id="shippingFee">@Model.ShippingFee.ToString("N0")</span>đ
                </div>
                <div class="cart-summary__row">
                    <span>Giảm giá:</span>
                    <span class="text-success">-0đ</span>
                </div>
                <div class="cart-summary__row cart-summary__total">
                    <span>Tổng cộng:</span>
                    <span id="grandTotal">@((Model.CartItems.Sum(i => i.Quantity * i.ProductVariant.Price) + Model.ShippingFee).ToString("N0"))</span>đ
                </div>
            </div>


            <!-- Nút đặt hàng -->
            <button type="submit" class="checkout__button">Đặt hàng</button>

            <!-- Thông báo bảo mật -->
            <div class="payment-notice">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                    <path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke="#3498db" stroke-width="2" />
                    <path d="M12 16V12M12 8H12.01" stroke="#3498db" stroke-width="2" stroke-linecap="round" />
                </svg>
                <span>Thông tin thanh toán của bạn được bảo mật và an toàn</span>
            </div>
        </div>
    </div>
</form>

@section Scripts {
    <script>
        // Handle payment method selection
               // Tăng / giảm số lượng
        document.querySelectorAll('.cart-item__quantity-wrapper').forEach(wrapper => {
            const input = wrapper.querySelector('.cart-item__quantity-input');
            const btnIncrease = wrapper.querySelector('.qty-increase');
            const btnDecrease = wrapper.querySelector('.qty-decrease');

            btnIncrease.addEventListener('click', () => {
                input.value = parseInt(input.value) + 1;
                updateCartItemTotal(wrapper.closest('.cart-item'));
            });

            btnDecrease.addEventListener('click', () => {
                if (parseInt(input.value) > 1) {
                    input.value = parseInt(input.value) - 1;
                    updateCartItemTotal(wrapper.closest('.cart-item'));
                }
            });
        });

        // Cập nhật giá từng sản phẩm và tổng tiền
        function updateCartItemTotal(cartItem) {
            const quantity = parseInt(cartItem.querySelector('.cart-item__quantity-input').value);
            const unitPrice = parseInt(cartItem.querySelector('.cart-item__price').dataset.unitPrice);

            // Update giá sản phẩm
            cartItem.querySelector('.cart-item__price').textContent = (quantity * unitPrice).toLocaleString() + 'đ';

            // Update subtotal và tổng cộng
            updateCartSummary();
        }

        // Cập nhật subtotal & tổng cộng
        function updateCartSummary() {
            let subtotal = 0;
            document.querySelectorAll('.cart-item').forEach(item => {
                const price = parseInt(item.querySelector('.cart-item__price').dataset.unitPrice);
                const qty = parseInt(item.querySelector('.cart-item__quantity-input').value);
                subtotal += price * qty;
            });

            const shipping = parseInt(document.getElementById('shippingFee').textContent.replace(/[^0-9]/g, '')) || 0;
            const grandTotal = subtotal + shipping;

            document.getElementById('subtotal').textContent = subtotal.toLocaleString();
            document.getElementById('grandTotal').textContent = grandTotal.toLocaleString();
        }

        // Khởi tạo lần đầu
        updateCartSummary();



    </script>
}