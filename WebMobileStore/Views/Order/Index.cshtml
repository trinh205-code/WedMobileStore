@model WebMobileStore.ViewModels.CheckoutViewModel
@{
    ViewBag.Title = "Thanh toán";
    Layout = "_ShopLayout";
}

@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger">@TempData["ErrorMessage"]</div>
}
@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success">@TempData["SuccessMessage"]</div>
}

<form asp-controller="Order" asp-action="PlaceOrder" method="post" class="checkout">
    @Html.AntiForgeryToken()

    <div class="checkout__container">
        <!-- Thông tin vận chuyển -->
        <div class="checkout__left">
            <h3 class="checkout__title">Thông tin vận chuyển</h3>

            <input asp-for="FullName" placeholder="Họ tên" class="checkout__input" required />
            <span asp-validation-for="FullName" class="text-danger"></span>

            <input asp-for="Phone" placeholder="Số điện thoại" class="checkout__input" required />
            <span asp-validation-for="Phone" class="text-danger"></span>

            <input asp-for="Email" placeholder="Email" class="checkout__input" type="email" required />
            <span asp-validation-for="Email" class="text-danger"></span>

            <div class="checkout__input-row">
                <input asp-for="Ward" placeholder="Phường/Xã" class="checkout__input" required />
                <input asp-for="District" placeholder="Quận/Huyện" class="checkout__input" required />
            </div>
            <span asp-validation-for="Ward" class="text-danger"></span>
            <span asp-validation-for="District" class="text-danger"></span>

            <input asp-for="City" placeholder="Tỉnh/Thành phố" class="checkout__input" required />
            <span asp-validation-for="City" class="text-danger"></span>

            <input type="hidden" asp-for="ShippingFee" />

            <!-- Hình thức thanh toán -->
            <div class="checkout__payment">
                <h3 class="checkout__title">Hình thức thanh toán</h3>

                <div class="payment-methods">
                    <!-- Thanh toán khi nhận hàng -->
                    <label class="payment-method">
                        <input type="radio" asp-for="PaymentMethod" value="COD" checked />
                        <div class="payment-method__content">
                            <div class="payment-method__icon">
                                <svg width="32" height="32" viewBox="0 0 24 24" fill="none">
                                    <path d="M20 7H4C2.89543 7 2 7.89543 2 9V17C2 18.1046 2.89543 19 4 19H20C21.1046 19 22 18.1046 22 17V9C22 7.89543 21.1046 7 20 7Z" stroke="currentColor" stroke-width="2" />
                                    <path d="M8 15C9.10457 15 10 14.1046 10 13C10 11.8954 9.10457 11 8 11C6.89543 11 6 11.8954 6 13C6 14.1046 6.89543 15 8 15Z" stroke="currentColor" stroke-width="2" />
                                    <path d="M18 7V5C18 3.89543 17.1046 3 16 3H8C6.89543 3 6 3.89543 6 5V7" stroke="currentColor" stroke-width="2" />
                                </svg>
                            </div>
                            <div class="payment-method__info">
                                <strong>Thanh toán khi nhận hàng</strong>
                                <small>Thanh toán bằng tiền mặt khi nhận hàng</small>
                            </div>
                        </div>
                    </label>

                    <!-- Thanh toán qua ZaloPay -->
                    <label class="payment-method">
                        <input type="radio" asp-for="PaymentMethod" value="ZaloPay" />
                        <div class="payment-method__content">
                            <div class="payment-method__icon payment-method__icon--zalopay">
                                <svg width="32" height="32" viewBox="0 0 24 24" fill="none">
                                    <circle cx="12" cy="12" r="10" fill="#0068FF" />
                                    <path d="M8 12L11 15L16 9" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                </svg>
                            </div>
                            <div class="payment-method__info">
                                <strong>Thanh toán qua ZaloPay</strong>
                                <small>Hỗ trợ hình thức thanh toán: Visa, MasterCard, JCB, Napas</small>
                            </div>
                        </div>
                    </label>

                    <!-- Chuyển khoản ngân hàng -->
                    <label class="payment-method">
                        <input type="radio" asp-for="PaymentMethod" value="BankTransfer" />
                        <div class="payment-method__content">
                            <div class="payment-method__icon payment-method__icon--bank">
                                <svg width="32" height="32" viewBox="0 0 24 24" fill="none">
                                    <path d="M3 9L12 2L21 9V20C21 20.5523 20.5523 21 20 21H4C3.44772 21 3 20.5523 3 20V9Z" stroke="currentColor" stroke-width="2" />
                                    <path d="M9 21V12H15V21" stroke="currentColor" stroke-width="2" />
                                </svg>
                            </div>
                            <div class="payment-method__info">
                                <strong>Chuyển khoản ngân hàng</strong>
                                <small>Chuyển khoản qua tài khoản ngân hàng</small>
                            </div>
                        </div>
                    </label>

                    <!-- Ví điện tử Momo -->
                    <label class="payment-method">
                        <input type="radio" asp-for="PaymentMethod" value="Momo" />
                        <div class="payment-method__content">
                            <div class="payment-method__icon payment-method__icon--momo">
                                <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
                                    <circle cx="16" cy="16" r="16" fill="#D82D8B" />
                                    <text x="16" y="21" text-anchor="middle" fill="white" font-weight="bold" font-size="14">M</text>
                                </svg>
                            </div>
                            <div class="payment-method__info">
                                <strong>Ví điện tử Momo</strong>
                                <small>Thanh toán qua ví điện tử Momo</small>
                            </div>
                        </div>
                    </label>
                </div>
            </div>
        </div>

        <!-- Giỏ hàng -->
        <div class="checkout__cart">
            <h3 class="checkout__title">Giỏ hàng</h3>
            @for (int i = 0; i < Model.CartItems.Count; i++)
            {
                var item = Model.CartItems[i];
                <div class="cart-item">
                    <div class="cart-item__image">
                        @{
                            var firstImage = "/images/default.png";
                            if (item.ProductVariant?.Products?.ProductImages?.Any() == true)
                            {
                                firstImage = item.ProductVariant.Products.ProductImages.First().ImageUrl;
                            }
                        }
                        <img src="@firstImage" alt="@item.ProductVariant?.Products?.ProductsName ?? " Sản phẩm" />

                        <div class="cart-item__quantity-wrapper">
                            <button type="button" class="qty-btn qty-decrease">-</button>
                            <input type="text" asp-for="@Model.CartItems[i].Quantity" class="cart-item__quantity-input" readonly />
                            <button type="button" class="qty-btn qty-increase">+</button>
                        </div>
                    </div>

                    <div class="cart-item__info">
                        <span class="cart-item__name">@item.ProductVariant?.Products?.ProductsName</span>
                        <span class="cart-item__variant">@item.ProductVariant?.Color / @item.ProductVariant?.Storage </span>
                    </div>

                    <span class="cart-item__price" data-unit-price="@item.ProductVariant?.Price ?? 0">
                        @((item.Quantity * (item.ProductVariant?.Price ?? 0)).ToString("N0"))đ
                    </span>

                    <input type="hidden" asp-for="@Model.CartItems[i].CartItemId" />
                    <input type="hidden" asp-for="@Model.CartItems[i].ProductVariantId" />
                </div>
            }

            <!-- Chi tiết thanh toán -->
            <div class="cart-summary">
                <div class="cart-summary__row">
                    <span>Tạm tính:</span>
                    <span id="subtotal">@Model.CartItems.Where(x => x.ProductVariant != null).Sum(x => x.Quantity * x.ProductVariant.Price).ToString("N0")</span>đ
                </div>
                <div class="cart-summary__row">
                    <span>Phí vận chuyển:</span>
                    <span id="shippingFee">@Model.ShippingFee.ToString("N0")</span>đ
                </div>
                <div class="cart-summary__row cart-summary__total">
                    <span>Tổng cộng:</span>
                    <span id="grandTotal">@((Model.CartItems.Where(x => x.ProductVariant != null).Sum(x => x.Quantity * x.ProductVariant.Price) + Model.ShippingFee).ToString("N0"))</span>đ
                </div>
            </div>

            <button type="submit" class="checkout__button">Đặt hàng</button>
        </div>
    </div>
</form>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        // Handle payment method selection
        document.querySelectorAll('.payment-method').forEach(method => {
            method.addEventListener('click', () => {
                document.querySelectorAll('.payment-method').forEach(m => m.classList.remove('selected'));
                method.classList.add('selected');
                const radio = method.querySelector('input[type="radio"]');
                if (radio) radio.checked = true;
            });
        });

        // Khởi tạo: Highlight phương thức mặc định (COD)
        document.addEventListener('DOMContentLoaded', function() {
            const defaultRadio = document.querySelector('input[name="PaymentMethod"]:checked');
            if (defaultRadio) {
                defaultRadio.closest('.payment-method').classList.add('selected');
            }
        });

        // Tăng / giảm số lượng
        document.querySelectorAll('.cart-item__quantity-wrapper').forEach(wrapper => {
            const input = wrapper.querySelector('.cart-item__quantity-input');
            const btnIncrease = wrapper.querySelector('.qty-increase');
            const btnDecrease = wrapper.querySelector('.qty-decrease');

            btnIncrease.addEventListener('click', () => {
                input.value = parseInt(input.value) + 1;
                updateCartItemTotal(wrapper.closest('.cart-item'));
            });

            btnDecrease.addEventListener('click', () => {
                if (parseInt(input.value) > 1) {
                    input.value = parseInt(input.value) - 1;
                    updateCartItemTotal(wrapper.closest('.cart-item'));
                }
            });
        });

        // Cập nhật giá từng sản phẩm và tổng tiền
        function updateCartItemTotal(cartItem) {
            const quantity = parseInt(cartItem.querySelector('.cart-item__quantity-input').value);
            const unitPrice = parseInt(cartItem.querySelector('.cart-item__price').dataset.unitPrice);

            // Update giá sản phẩm
            cartItem.querySelector('.cart-item__price').textContent = (quantity * unitPrice).toLocaleString() + 'đ';

            // Update subtotal và tổng cộng
            updateCartSummary();
        }

        // Cập nhật subtotal & tổng cộng
        function updateCartSummary() {
            let subtotal = 0;
            document.querySelectorAll('.cart-item').forEach(item => {
                const price = parseInt(item.querySelector('.cart-item__price').dataset.unitPrice);
                const qty = parseInt(item.querySelector('.cart-item__quantity-input').value);
                subtotal += price * qty;
            });

            const shipping = parseInt(document.getElementById('shippingFee').textContent.replace(/[^0-9]/g, '')) || 0;
            const grandTotal = subtotal + shipping;

            document.getElementById('subtotal').textContent = subtotal.toLocaleString();
            document.getElementById('grandTotal').textContent = grandTotal.toLocaleString();
        }

        // Khởi tạo lần đầu
        updateCartSummary();
    </script>
}